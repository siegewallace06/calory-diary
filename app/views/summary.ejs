<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Summary - Calorie Diary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <%- include('partials/navbar') %>

        <div class="container mt-4">
            <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error: <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>

                    <!-- Page Header -->
                    <div class="row mb-4">
                        <div class="col">
                            <h1 class="page-title"><i class="fas fa-chart-bar me-2 text-primary"></i>Daily Summary</h1>
                            <p class="page-subtitle">Track your calorie history and progress</p>
                        </div>
                    </div>

                    <% if (summaries && summaries.length> 0) { %>
                        <!-- Summary Stats -->
                        <div class="row mb-4">
                            <% const totalDays=summaries.length; const avgCalories=Math.round(summaries.reduce((sum,
                                s)=> sum + parseFloat(s.totalIn || 0), 0) / totalDays);
                                const underGoalDays = summaries.filter(s => s.status.includes('Under')).length;
                                const successRate = Math.round((underGoalDays / totalDays) * 100);
                                %>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-calendar"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value">
                                                <%= totalDays %>
                                            </div>
                                            <div class="stat-label">Total Days</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-calculator"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value">
                                                <%= avgCalories %>
                                            </div>
                                            <div class="stat-label">Avg. Calories</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-thumbs-up"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value">
                                                <%= underGoalDays %>
                                            </div>
                                            <div class="stat-label">Under Goal Days</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-percentage"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value">
                                                <%= successRate %>%
                                            </div>
                                            <div class="stat-label">Success Rate</div>
                                        </div>
                                    </div>
                                </div>
                        </div>

                        <!-- Chart -->
                        <div class="row mb-4">
                            <div class="col">
                                <div class="modern-card">
                                    <div class="modern-card-header">
                                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Calorie Trend</h5>
                                    </div>
                                    <div class="modern-card-body">
                                        <canvas id="calorieChart" style="max-height: 400px;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary Table -->
                        <div class="row">
                            <div class="col">
                                <div class="modern-card">
                                    <div class="modern-card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Daily Records</h5>
                                        <small class="text-muted">Last <%= summaries.length %> days</small>
                                    </div>
                                    <div class="modern-card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th><i class="fas fa-calendar me-1"></i>Date</th>
                                                        <th><i class="fas fa-utensils me-1"></i>Consumed</th>
                                                        <th><i class="fas fa-target me-1"></i>Goal</th>
                                                        <th><i class="fas fa-balance-scale me-1"></i>Difference</th>
                                                        <th><i class="fas fa-chart-pie me-1"></i>Status</th>
                                                        <th><i class="fas fa-percentage me-1"></i>Progress</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% summaries.forEach(summary=> {
                                                        const consumed = parseFloat(summary.totalIn) || 0;
                                                        const goal = parseFloat(summary.maxLimit) || 1;
                                                        const difference = consumed - goal;
                                                        const percentage = Math.round((consumed / goal) * 100);
                                                        const isUnder = difference <= 0; %>
                                                            <tr>
                                                                <td>
                                                                    <strong>
                                                                        <%= new Date(summary.date).toLocaleDateString()
                                                                            %>
                                                                    </strong>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-info">
                                                                        <%= consumed %> cal
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-secondary">
                                                                        <%= goal %> cal
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <span
                                                                        class="badge <%= isUnder ? 'bg-success' : 'bg-danger' %>">
                                                                        <%= isUnder ? '' : '+' %>
                                                                            <%= Math.round(difference) %> cal
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <span
                                                                        class="badge <%= isUnder ? 'bg-success' : 'bg-danger' %>">
                                                                        <%= summary.status %>
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <div class="progress"
                                                                        style="width: 100px; height: 20px;">
                                                                        <div class="progress-bar <%= isUnder ? 'bg-success' : 'bg-danger' %>"
                                                                            role="progressbar"
                                                                            style="width: <%= Math.min(percentage, 100) %>%">
                                                                            <%= percentage %>%
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            <% }) %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% } else { %>
                            <!-- No Data State -->
                            <div class="row">
                                <div class="col">
                                    <div class="modern-card">
                                        <div class="modern-card-body text-center py-5">
                                            <i class="fas fa-chart-bar fa-4x text-muted mb-4"></i>
                                            <h3 class="text-muted">No Summary Data Available</h3>
                                            <p class="text-muted mb-4">Start logging your meals to see your daily
                                                summary here.</p>
                                            <a href="/log" class="btn-primary">
                                                <i class="fas fa-plus me-2"></i>Add Your First Entry
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <% } %>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <%- include('partials/scripts') %>

            <% if (summaries && summaries.length> 0) { %>
                <script>
                    // Prepare chart data
                    const summaries = <% - JSON.stringify(summaries.reverse()) %>; // Show chronologically
                    const labels = summaries.map(s => new Date(s.date).toLocaleDateString());
                    const consumedData = summaries.map(s => parseFloat(s.totalIn) || 0);
                    const goalData = summaries.map(s => parseFloat(s.maxLimit) || 0);

                    // Create chart
                    const ctx = document.getElementById('calorieChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Calories Consumed',
                                    data: consumedData,
                                    borderColor: 'rgb(54, 162, 235)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                    fill: true,
                                    tension: 0.1
                                },
                                {
                                    label: 'Daily Goal',
                                    data: goalData,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    borderDash: [5, 5],
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Calories'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        footer: function (tooltipItems) {
                                            const index = tooltipItems[0].dataIndex;
                                            const consumed = consumedData[index];
                                            const goal = goalData[index];
                                            const difference = consumed - goal;
                                            const status = difference <= 0 ?
                                                `Under goal by ${Math.abs(difference)} calories` :
                                                `Over goal by ${difference} calories`;
                                            return status;
                                        }
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                </script>
                <% } %>
</body>

</html>