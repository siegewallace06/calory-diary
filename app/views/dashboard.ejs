<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Diary - Dashboard</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Calorie Diary">
    <meta name="description" content="Track your daily calorie intake with intelligent goal monitoring">

    <!-- PWA Links -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/icons/icon.svg">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>

<body>
    <%- include('partials/navbar') %>

        <div class="container mt-4">
            <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error: <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>

                    <!-- Page Header -->
                    <div class="row mb-4">
                        <div class="col">
                            <h1 class="display-6 mb-1">
                                <i class="fas fa-chart-pie me-2" style="color: var(--primary-color);"></i>
                                Dashboard
                            </h1>
                            <p class="text-muted">Your daily calorie tracking overview</p>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary" onclick="refreshData()">
                                <i class="fas fa-refresh me-1"></i>Refresh
                            </button>
                        </div>
                    </div>

                    <% if (dashboard) { %>
                        <!-- Today's Summary Cards -->
                        <div class="row mb-4 g-3">
                            <div class="col-md-3 col-6">
                                <div class="stat-card h-100">
                                    <div class="stat-icon text-primary">
                                        <i class="fas fa-calendar-day"></i>
                                    </div>
                                    <div class="stat-value">Today</div>
                                    <div class="stat-label" id="current-date">
                                        Loading...
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="stat-card h-100">
                                    <div class="stat-icon text-success">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                    <div class="stat-value">
                                        <%= dashboard.today.totalIn %>
                                    </div>
                                    <div class="stat-label">Calories Consumed</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="stat-card h-100">
                                    <div class="stat-icon text-info">
                                        <i class="fas fa-bullseye"></i>
                                    </div>
                                    <div class="stat-value">
                                        <%= dashboard.today.maxLimit %>
                                    </div>
                                    <div class="stat-label">Daily Goal</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="stat-card h-100">
                                    <div
                                        class="stat-icon <%= dashboard.today.status.includes('Under') ? 'text-success' : 'text-danger' %>">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="stat-value" style="font-size: 1rem;">
                                        <span
                                            class="badge <%= dashboard.today.status.includes('Under') ? 'bg-success' : 'bg-danger' %>">
                                            <%= dashboard.today.status.includes('Under') ? 'On Track' : 'Over Goal' %>
                                        </span>
                                    </div>
                                    <div class="stat-label">Status</div>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Section -->
                        <div class="row mb-4">
                            <div class="col">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title mb-4">
                                            <i class="fas fa-chart-bar me-2 text-primary"></i>
                                            Today's Progress
                                        </h5>
                                        <% const consumed=parseFloat(dashboard.today.totalIn) || 0; const
                                            goal=parseFloat(dashboard.today.maxLimit) || 1; const
                                            percentage=Math.min((consumed / goal) * 100, 100); const isOver=consumed>
                                            goal;
                                            const remaining = goal - consumed;
                                            %>

                                            <!-- Large Progress Indicator -->
                                            <div class="row align-items-center mb-3">
                                                <div class="col-md-8">
                                                    <div class="progress mb-2" style="height: 12px;">
                                                        <div class="progress-bar <%= isOver ? 'bg-danger' : '' %>"
                                                            role="progressbar" style="width: <%= percentage %>%"
                                                            aria-valuenow="<%= percentage %>" aria-valuemin="0"
                                                            aria-valuemax="100">
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-between">
                                                        <small class="text-muted">0 cal</small>
                                                        <small class="text-muted">
                                                            <%= goal %> cal
                                                        </small>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 text-center">
                                                    <div class="h2 mb-0 <%= isOver ? 'text-danger' : 'text-success' %>">
                                                        <%= Math.round(percentage) %>%
                                                    </div>
                                                    <small class="text-muted">of daily goal</small>
                                                </div>
                                            </div>

                                            <!-- Status Summary -->
                                            <div class="row text-center">
                                                <div class="col-4">
                                                    <div class="h5 text-success mb-1">
                                                        <%= consumed %>
                                                    </div>
                                                    <small class="text-muted">Consumed</small>
                                                </div>
                                                <div class="col-4">
                                                    <div class="h5 <%= isOver ? 'text-danger' : 'text-success' %> mb-1">
                                                        <%= isOver ? '+' + Math.abs(remaining) : Math.abs(remaining) %>
                                                    </div>
                                                    <small class="text-muted">
                                                        <%= isOver ? 'Over' : 'Remaining' %>
                                                    </small>
                                                </div>
                                                <div class="col-4">
                                                    <div class="h5 text-info mb-1">
                                                        <%= goal %>
                                                    </div>
                                                    <small class="text-muted">Goal</small>
                                                </div>
                                            </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Two Column Layout -->
                        <div class="row mb-4 g-4">
                            <!-- Personal Metrics -->
                            <div class="col-lg-6">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-user me-2"></i>
                                            Personal Metrics
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-venus-mars me-2 text-muted"></i>
                                                    <strong>Gender:</strong>
                                                </div>
                                                <div class="ms-4 text-muted">
                                                    <%= dashboard.personal.gender %>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-weight me-2 text-muted"></i>
                                                    <strong>Weight:</strong>
                                                </div>
                                                <div class="ms-4 text-muted">
                                                    <%= dashboard.personal.weight %> kg
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-ruler-vertical me-2 text-muted"></i>
                                                    <strong>Height:</strong>
                                                </div>
                                                <div class="ms-4 text-muted">
                                                    <%= dashboard.personal.height %> cm
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-birthday-cake me-2 text-muted"></i>
                                                    <strong>Age:</strong>
                                                </div>
                                                <div class="ms-4 text-muted">
                                                    <%= dashboard.personal.age %> years
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-running me-2 text-muted"></i>
                                                    <strong>Activity:</strong>
                                                </div>
                                                <div class="ms-4 text-muted">
                                                    <%= dashboard.personal.activityLevel %>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-bullseye me-2 text-muted"></i>
                                                    <strong>Goal:</strong>
                                                </div>
                                                <div class="ms-4 text-muted">
                                                    <%= dashboard.personal.goalOffset %>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mt-4 p-3 bg-light rounded">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <strong class="text-primary">Daily Calorie Goal:</strong>
                                                <span class="badge bg-primary fs-6">
                                                    <%= dashboard.personal.dailyGoal %> calories
                                                </span>
                                            </div>
                                        </div>

                                        <div class="mt-3">
                                            <a href="/settings" class="btn btn-outline-primary w-100">
                                                <i class="fas fa-edit me-1"></i>Update Metrics
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Entries -->
                            <div class="col-lg-6">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-list me-2"></i>
                                            Recent Entries
                                        </h5>
                                        <a href="/log" class="btn btn-success btn-sm">
                                            <i class="fas fa-plus me-1"></i>Add Entry
                                        </a>
                                    </div>
                                    <div class="card-body">
                                        <% if (recentEntries && recentEntries.length> 0) { %>
                                            <% recentEntries.forEach((entry, index)=> { %>
                                                <div
                                                    class="list-group-item <%= index === recentEntries.length - 1 ? 'mb-0' : 'mb-2' %>">
                                                    <div class="d-flex w-100 justify-content-between align-items-start">
                                                        <div class="flex-grow-1">
                                                            <h6 class="mb-1">
                                                                <%= entry.description %>
                                                            </h6>
                                                            <p class="mb-1">
                                                                <span class="badge bg-secondary me-2">
                                                                    <%= entry.mealType %>
                                                                </span>
                                                            </p>
                                                            <small class="text-muted">
                                                                <i class="fas fa-calendar me-1"></i>
                                                                <%= entry.date %>
                                                                    <% if (entry.time) { %>
                                                                        <i class="fas fa-clock ms-2 me-1"></i>
                                                                        <%= entry.time %>
                                                                            <% } %>
                                                            </small>
                                                        </div>
                                                        <span class="badge bg-success ms-2">
                                                            <strong>
                                                                <%= entry.calories %> cal
                                                            </strong>
                                                        </span>
                                                    </div>
                                                </div>
                                                <% }) %>

                                                    <div class="mt-3 text-center">
                                                        <a href="/log" class="btn btn-outline-primary btn-sm">
                                                            View All Entries
                                                        </a>
                                                    </div>
                                                    <% } else { %>
                                                        <div class="text-center text-muted py-5">
                                                            <i class="fas fa-utensils fa-3x mb-3 opacity-25"></i>
                                                            <p class="mb-3">No food entries yet</p>
                                                            <a href="/log" class="btn btn-success">
                                                                <i class="fas fa-plus me-1"></i>Add Your First Entry
                                                            </a>
                                                        </div>
                                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% } %>

                            <!-- Quick Actions -->
                            <div class="row">
                                <div class="col">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title mb-3">
                                                <i class="fas fa-bolt me-2 text-warning"></i>
                                                Quick Actions
                                            </h5>
                                            <div class="row g-2">
                                                <div class="col-lg-3 col-md-6 col-12">
                                                    <a href="/log" class="btn btn-success w-100">
                                                        <i class="fas fa-plus me-2"></i>Add Food Entry
                                                    </a>
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-12">
                                                    <a href="/summary" class="btn btn-outline-primary w-100">
                                                        <i class="fas fa-chart-bar me-2"></i>View Summary
                                                    </a>
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-12">
                                                    <a href="/settings" class="btn btn-outline-secondary w-100">
                                                        <i class="fas fa-cog me-2"></i>Settings
                                                    </a>
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-12">
                                                    <button onclick="refreshData()" class="btn btn-outline-info w-100">
                                                        <i class="fas fa-refresh me-2"></i>Refresh Data
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
        </div>

        <%- include('partials/scripts') %>

            <script>
                // Update current date on client-side to avoid cache issues
                document.getElementById('current-date').textContent =
                    new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                // Check if dashboard data is from today and update if not
                async function checkDashboardDate() {
                    const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format
                    const dashboardDate = '<%= dashboard ? new Date(dashboard.today.date).toLocaleDateString("en-CA") : "" %>';

                    if (dashboardDate && dashboardDate !== today) {
                        console.log(`Dashboard showing data from ${dashboardDate}, updating to today (${today})`);

                        // Show updating message
                        const progressTitle = document.querySelector('.card-title');
                        if (progressTitle && progressTitle.textContent.includes("Today's Progress")) {
                            progressTitle.innerHTML = `
                                <i class="fas fa-chart-bar me-2 text-primary"></i>
                                Today's Progress 
                                <small class="text-info ms-2">
                                    <i class="fas fa-sync fa-spin me-1"></i>
                                    Updating to today's date...
                                </small>
                            `;
                        }

                        try {
                            // Call API to update dashboard date
                            const response = await fetch('/api/update-dashboard-date', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });

                            if (response.ok) {
                                console.log('Dashboard date updated successfully');
                                // Reload page after a short delay to show updated data
                                setTimeout(() => window.location.reload(), 1500);
                            } else {
                                console.error('Failed to update dashboard date');
                                // Show error message
                                if (progressTitle) {
                                    progressTitle.innerHTML = `
                                        <i class="fas fa-chart-bar me-2 text-primary"></i>
                                        Today's Progress 
                                        <small class="text-warning ms-2">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Showing data from ${new Date(dashboardDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                        </small>
                                    `;
                                }
                            }
                        } catch (error) {
                            console.error('Error updating dashboard date:', error);
                        }
                    } else {
                        console.log('Dashboard data is current for today');
                    }
                }

                // Run date validation on page load
                checkDashboardDate();

                // Auto-refresh every 5 minutes to get latest data from spreadsheet
                setInterval(() => {
                    window.location.reload();
                }, 300000); // 5 minutes

                console.log('Dashboard loaded - Google Apps Script onEdit trigger handles all calculations automatically');
            </script>
</body>

</html>