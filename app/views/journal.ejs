<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Diary - Journal</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Calorie Diary">
    <meta name="description" content="Daily food journal with calendar view">

    <!-- PWA Links -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/icons/icon.svg">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">

    <style>
        .calendar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .calendar-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .calendar-nav {
            background: #f8f9fa;
            padding: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
        }

        .calendar-nav button {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: #e9ecef;
            color: #495057;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            background: #f8f9fa;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            font-size: 0.875rem;
            border-right: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }

        .calendar-day-header:last-child {
            border-right: none;
        }

        .calendar-day {
            min-height: 80px;
            padding: 0.5rem;
            border-right: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-day:last-child {
            border-right: none;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            color: #ced4da;
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .calendar-day.has-data {
            background: #f0f9ff;
        }

        .calendar-day.has-data.over-goal {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }

        .calendar-day.has-data.under-goal {
            background: #f0fdf4;
            border-left: 4px solid #22c55e;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .day-calories {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .day-status {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            margin-top: 0.25rem;
            display: inline-block;
        }

        .day-status.over {
            background: #fee2e2;
            color: #dc2626;
        }

        .day-status.under {
            background: #dcfce7;
            color: #16a34a;
        }

        .day-details {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none;
        }

        .day-details.show {
            display: block;
        }

        .entry-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid #6366f1;
        }

        .entry-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #6c757d;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .no-entries {
            text-align: center;
            color: #6c757d;
            padding: 2rem;
        }
    </style>
</head>

<body>
    <%- include('partials/navbar', {currentPage: 'journal' }) %>

        <div class="container mt-4">
            <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error: <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>

                    <!-- Page Header -->
                    <div class="row mb-4">
                        <div class="col">
                            <h1 class="display-6 mb-1">
                                <i class="fas fa-book me-2" style="color: var(--primary-color);"></i>
                                Food Journal
                            </h1>
                            <p class="text-muted">Track your daily eating patterns with calendar view</p>
                        </div>
                        <div class="col-auto">
                            <a href="/log" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i>Add Entry
                            </a>
                        </div>
                    </div>

                    <!-- Calendar View -->
                    <div class="row">
                        <div class="col">
                            <div class="calendar">
                                <div class="calendar-header">
                                    <h4 class="mb-0">
                                        <i class="fas fa-calendar me-2"></i>
                                        <span id="current-month-year">Loading...</span>
                                    </h4>
                                </div>

                                <div class="calendar-nav">
                                    <button type="button" onclick="previousMonth()">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div class="d-flex gap-3">
                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                            onclick="goToToday()">
                                            Today
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                            onclick="refreshCalendar()">
                                            <i class="fas fa-refresh"></i>
                                        </button>
                                    </div>
                                    <button type="button" onclick="nextMonth()">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>

                                <div class="calendar-grid" id="calendar-grid">
                                    <!-- Day headers -->
                                    <div class="calendar-day-header">Sun</div>
                                    <div class="calendar-day-header">Mon</div>
                                    <div class="calendar-day-header">Tue</div>
                                    <div class="calendar-day-header">Wed</div>
                                    <div class="calendar-day-header">Thu</div>
                                    <div class="calendar-day-header">Fri</div>
                                    <div class="calendar-day-header">Sat</div>

                                    <!-- Calendar days will be inserted here dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Day Details -->
                    <div id="day-details" class="day-details">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar-day me-2"></i>
                                <span id="selected-date">Selected Date</span>
                            </h5>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closeDayDetails()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Daily Summary -->
                        <div id="daily-summary" class="mb-4"></div>

                        <!-- Food Entries -->
                        <div id="daily-entries">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
        </div>

        <%- include('partials/scripts') %>

            <script>
                let currentMonth = <%= currentMonth %>;
                let currentYear = <%= currentYear %>;
                let calendarData = {};

                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];

                // Initialize calendar on page load
                document.addEventListener('DOMContentLoaded', function () {
                    updateCalendar();
                });

                async function updateCalendar() {
                    try {
                        // Update header
                        document.getElementById('current-month-year').textContent =
                            `${monthNames[currentMonth]} ${currentYear}`;

                        // Fetch calendar data
                        const response = await fetch(`/api/journal/calendar?year=${currentYear}&month=${currentMonth}`);
                        const result = await response.json();

                        if (result.success) {
                            calendarData = result.data;
                            renderCalendar();
                        } else {
                            console.error('Failed to fetch calendar data');
                        }
                    } catch (error) {
                        console.error('Error updating calendar:', error);
                    }
                }

                function renderCalendar() {
                    const calendarGrid = document.getElementById('calendar-grid');

                    // Remove existing day elements (keep headers)
                    const dayElements = calendarGrid.querySelectorAll('.calendar-day');
                    dayElements.forEach(element => element.remove());

                    // Get first day of month and number of days
                    const firstDay = new Date(currentYear, currentMonth, 1);
                    const lastDay = new Date(currentYear, currentMonth + 1, 0);
                    const daysInMonth = lastDay.getDate();
                    const startDate = firstDay.getDay(); // 0 = Sunday

                    // Add previous month's trailing days
                    const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                    const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                    const prevMonthDays = new Date(prevYear, prevMonth + 1, 0).getDate();

                    for (let i = startDate - 1; i >= 0; i--) {
                        const day = prevMonthDays - i;
                        const dayElement = createDayElement(day, true);
                        calendarGrid.appendChild(dayElement);
                    }

                    // Add current month's days
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayElement = createDayElement(day, false);
                        calendarGrid.appendChild(dayElement);
                    }

                    // Add next month's leading days to fill the grid
                    const totalCells = calendarGrid.children.length - 7; // Subtract headers
                    const remainingCells = 35 - totalCells; // 5 rows Ã— 7 days (42 - 7 headers)

                    for (let day = 1; day <= remainingCells; day++) {
                        const dayElement = createDayElement(day, true);
                        calendarGrid.appendChild(dayElement);
                    }
                }

                function createDayElement(day, isOtherMonth) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';

                    if (isOtherMonth) {
                        dayElement.classList.add('other-month');
                    }

                    // Check if it's today
                    const today = new Date();
                    if (!isOtherMonth &&
                        day === today.getDate() &&
                        currentMonth === today.getMonth() &&
                        currentYear === today.getFullYear()) {
                        dayElement.classList.add('today');
                    }

                    // Check if there's data for this day
                    const dayData = calendarData[day];
                    if (dayData && !isOtherMonth) {
                        dayElement.classList.add('has-data');
                        dayElement.classList.add(dayData.isOver ? 'over-goal' : 'under-goal');
                    }

                    dayElement.innerHTML = `
                <div class="day-number">${day}</div>
                ${dayData && !isOtherMonth ? `
                    <div class="day-calories">${dayData.totalCalories}/${dayData.maxCalories} cal</div>
                    <div class="day-status ${dayData.isOver ? 'over' : 'under'}">
                        ${dayData.isOver ? 'Over' : 'Under'}
                    </div>
                ` : ''}
            `;

                    // Add click handler for days with data
                    if (dayData && !isOtherMonth) {
                        dayElement.addEventListener('click', () => showDayDetails(day));
                    }

                    return dayElement;
                }

                async function showDayDetails(day) {
                    const selectedDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                    document.getElementById('selected-date').textContent =
                        new Date(selectedDate).toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            timeZone: 'Asia/Jakarta'
                        });

                    // Show details panel
                    const detailsPanel = document.getElementById('day-details');
                    detailsPanel.classList.add('show');
                    detailsPanel.scrollIntoView({ behavior: 'smooth' });

                    // Reset content
                    document.getElementById('daily-summary').innerHTML = '';
                    document.getElementById('daily-entries').innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;

                    try {
                        const response = await fetch(`/api/journal/date/${selectedDate}`);
                        const result = await response.json();

                        if (result.success) {
                            renderDayDetails(result.data);
                        } else {
                            document.getElementById('daily-entries').innerHTML = `
                        <div class="alert alert-danger">Failed to load day details</div>
                    `;
                        }
                    } catch (error) {
                        console.error('Error loading day details:', error);
                        document.getElementById('daily-entries').innerHTML = `
                    <div class="alert alert-danger">Error loading day details</div>
                `;
                    }
                }

                function renderDayDetails(data) {
                    const { entries, summary } = data;

                    // Render summary
                    if (summary) {
                        const isOver = summary.totalIn > summary.maxLimit;
                        document.getElementById('daily-summary').innerHTML = `
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-success">${summary.totalIn}</h5>
                                    <p class="card-text text-muted">Calories Consumed</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-info">${summary.maxLimit}</h5>
                                    <p class="card-text text-muted">Daily Goal</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title ${isOver ? 'text-danger' : 'text-success'}">
                                        ${isOver ? '+' + (summary.totalIn - summary.maxLimit) : (summary.maxLimit - summary.totalIn)}
                                    </h5>
                                    <p class="card-text text-muted">${isOver ? 'Over Goal' : 'Remaining'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    }

                    // Render entries
                    if (entries && entries.length > 0) {
                        const entriesHtml = entries.map(entry => `
                    <div class="entry-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${entry.description}</h6>
                                <div class="entry-meta">
                                    <span><i class="fas fa-tag me-1"></i>${entry.mealType}</span>
                                    ${entry.time ? `<span><i class="fas fa-clock me-1"></i>${entry.time}</span>` : ''}
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success fs-6">${entry.calories} cal</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                        document.getElementById('daily-entries').innerHTML = `
                    <h6 class="mb-3">
                        <i class="fas fa-utensils me-2"></i>
                        Food Entries (${entries.length})
                    </h6>
                    ${entriesHtml}
                `;
                    } else {
                        document.getElementById('daily-entries').innerHTML = `
                    <div class="no-entries">
                        <i class="fas fa-utensils fa-3x mb-3 opacity-25"></i>
                        <p>No food entries for this day</p>
                        <a href="/log" class="btn btn-success">
                            <i class="fas fa-plus me-1"></i>Add Entry
                        </a>
                    </div>
                `;
                    }
                }

                function closeDayDetails() {
                    document.getElementById('day-details').classList.remove('show');
                }

                function previousMonth() {
                    if (currentMonth === 0) {
                        currentMonth = 11;
                        currentYear--;
                    } else {
                        currentMonth--;
                    }
                    updateCalendar();
                }

                function nextMonth() {
                    if (currentMonth === 11) {
                        currentMonth = 0;
                        currentYear++;
                    } else {
                        currentMonth++;
                    }
                    updateCalendar();
                }

                function goToToday() {
                    const today = new Date();
                    currentMonth = today.getMonth();
                    currentYear = today.getFullYear();
                    updateCalendar();
                }

                function refreshCalendar() {
                    updateCalendar();
                }

                console.log('Journal page loaded');
            </script>
</body>

</html>