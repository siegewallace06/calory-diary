<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Calorie Diary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <%- include('partials/navbar') %>

        <div class="container mt-4">
            <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error: <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>

                    <% if (success) { %>
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <%= success %>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        <% } %>

                            <!-- Page Header -->
                            <div class="row mb-4">
                                <div class="col">
                                    <h1 class="display-6 mb-0"><i class="fas fa-cog me-2 text-warning"></i>Settings</h1>
                                    <p class="text-muted">Update your personal metrics and goals</p>
                                </div>
                            </div>

                            <div class="row justify-content-center">
                                <div class="col-lg-8">
                                    <div class="card shadow">
                                        <div class="card-header">
                                            <h5 class="mb-0"><i class="fas fa-user-cog me-2"></i>Personal Metrics</h5>
                                            <small class="text-muted">These values are used to calculate your daily
                                                calorie goal using the Mifflin-St Jeor equation</small>
                                        </div>
                                        <div class="card-body">
                                            <form id="settingsForm" onsubmit="submitSettings(event)">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="gender" class="form-label">
                                                            <i class="fas fa-venus-mars me-1"></i>Gender *
                                                        </label>
                                                        <select class="form-select" id="gender" name="gender" required>
                                                            <option value="">Choose gender...</option>
                                                            <option value="Male" <%=personal.gender==='Male'
                                                                ? 'selected' : '' %>>Male</option>
                                                            <option value="Female" <%=personal.gender==='Female'
                                                                ? 'selected' : '' %>>Female</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="age" class="form-label">
                                                            <i class="fas fa-birthday-cake me-1"></i>Age *
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="age"
                                                                name="age" min="10" max="120" step="1"
                                                                value="<%= personal.age || '' %>" required>
                                                            <span class="input-group-text">years</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="weight" class="form-label">
                                                            <i class="fas fa-weight me-1"></i>Weight *
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="weight"
                                                                name="weight" min="30" max="300" step="0.1"
                                                                value="<%= personal.weight || '' %>" required>
                                                            <span class="input-group-text">kg</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="height" class="form-label">
                                                            <i class="fas fa-ruler-vertical me-1"></i>Height *
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="height"
                                                                name="height" min="100" max="250" step="1"
                                                                value="<%= personal.height || '' %>" required>
                                                            <span class="input-group-text">cm</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="activityLevel" class="form-label">
                                                        <i class="fas fa-running me-1"></i>Activity Level *
                                                    </label>
                                                    <select class="form-select" id="activityLevel" name="activityLevel"
                                                        required>
                                                        <option value="">Choose activity level...</option>
                                                        <option value="1.2 (Sedentary)"
                                                            <%=personal.activityLevel==='1.2 (Sedentary)' ? 'selected'
                                                            : '' %>>
                                                            1.2 - Sedentary (little or no exercise)
                                                        </option>
                                                        <option value="1.375 (Light)"
                                                            <%=personal.activityLevel==='1.375 (Light)' ? 'selected'
                                                            : '' %>>
                                                            1.375 - Lightly Active (light exercise 1-3 days/week)
                                                        </option>
                                                        <option value="1.55 (Moderate)"
                                                            <%=personal.activityLevel==='1.55 (Moderate)' ? 'selected'
                                                            : '' %>>
                                                            1.55 - Moderately Active (moderate exercise 3-5 days/week)
                                                        </option>
                                                        <option value="1.725 (Very Active)"
                                                            <%=personal.activityLevel==='1.725 (Very Active)'
                                                            ? 'selected' : '' %>>
                                                            1.725 - Very Active (hard exercise 6-7 days/week)
                                                        </option>
                                                        <option value="1.9 (Extremely Active)"
                                                            <%=personal.activityLevel==='1.9 (Extremely Active)'
                                                            ? 'selected' : '' %>>
                                                            1.9 - Extremely Active (very hard exercise + physical job)
                                                        </option>
                                                    </select>
                                                    <div class="form-text">This multiplier is applied to your BMR to
                                                        calculate total daily energy expenditure</div>
                                                </div>

                                                <div class="mb-4">
                                                    <label for="goalOffset" class="form-label">
                                                        <i class="fas fa-bullseye me-1"></i>Goal *
                                                    </label>
                                                    <select class="form-select" id="goalOffset" name="goalOffset"
                                                        required>
                                                        <option value="">Choose your goal...</option>
                                                        <option value="-500 (Weight Loss)"
                                                            <%=personal.goalOffset==='-500 (Weight Loss)' ? 'selected'
                                                            : '' %>>
                                                            -500 calories - Weight Loss (~0.5 kg/week)
                                                        </option>
                                                        <option value="0 (Maintenance)"
                                                            <%=personal.goalOffset==='0 (Maintenance)' ? 'selected' : ''
                                                            %>>
                                                            0 calories - Maintenance (maintain current weight)
                                                        </option>
                                                        <option value="500 (Weight Gain)"
                                                            <%=personal.goalOffset==='500 (Weight Gain)' ? 'selected'
                                                            : '' %>>
                                                            +500 calories - Weight Gain (~0.5 kg/week)
                                                        </option>
                                                    </select>
                                                    <div class="form-text">Calorie adjustment applied to your daily
                                                        energy expenditure</div>
                                                </div>

                                                <!-- Calculated Goal Display -->
                                                <div class="alert alert-info" id="goalPreview" style="display: none;">
                                                    <h6><i class="fas fa-calculator me-2"></i>Your Calculated Daily
                                                        Goal:</h6>
                                                    <div id="goalCalculation"></div>
                                                </div>

                                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                                    <button type="button" class="btn btn-outline-secondary me-md-2"
                                                        onclick="resetForm()">
                                                        <i class="fas fa-undo me-1"></i>Reset
                                                    </button>
                                                    <button type="submit" class="btn btn-warning" id="submitBtn">
                                                        <i class="fas fa-save me-1"></i>Save Settings
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- Formula Explanation -->
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>How Your Goal is
                                                Calculated</h5>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Step 1: Calculate BMR (Basal Metabolic Rate)</strong></p>
                                            <ul>
                                                <li><strong>Men:</strong> BMR = (10 × weight) + (6.25 × height) - (5 ×
                                                    age) + 5</li>
                                                <li><strong>Women:</strong> BMR = (10 × weight) + (6.25 × height) - (5 ×
                                                    age) - 161</li>
                                            </ul>

                                            <p><strong>Step 2: Calculate TDEE (Total Daily Energy Expenditure)</strong>
                                            </p>
                                            <p>TDEE = BMR × Activity Level Multiplier</p>

                                            <p><strong>Step 3: Apply Goal Adjustment</strong></p>
                                            <p>Daily Goal = TDEE + Goal Offset</p>

                                            <div class="alert alert-light">
                                                <small class="text-muted">
                                                    <i class="fas fa-lightbulb me-1"></i>
                                                    This calculation uses the scientifically-validated Mifflin-St Jeor
                                                    equation,
                                                    which is considered one of the most accurate methods for estimating
                                                    caloric needs.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            function submitSettings(event) {
                event.preventDefault();

                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
                submitBtn.disabled = true;

                const formData = new FormData(document.getElementById('settingsForm'));
                const data = Object.fromEntries(formData.entries());

                fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('success', 'Settings saved successfully! Your daily goal has been updated.');
                            updateGoalPreview();
                        } else {
                            showAlert('danger', 'Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        showAlert('danger', 'Error: ' + error.message);
                    })
                    .finally(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    });
            }

            function resetForm() {
                document.getElementById('settingsForm').reset();
                document.getElementById('goalPreview').style.display = 'none';
            }

            function calculateGoal() {
                const gender = document.getElementById('gender').value;
                const weight = parseFloat(document.getElementById('weight').value);
                const height = parseFloat(document.getElementById('height').value);
                const age = parseFloat(document.getElementById('age').value);
                const activityText = document.getElementById('activityLevel').value;
                const goalText = document.getElementById('goalOffset').value;

                if (!gender || !weight || !height || !age || !activityText || !goalText) {
                    return null;
                }

                // Calculate BMR
                let bmr;
                if (gender.toLowerCase() === 'male') {
                    bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
                } else {
                    bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
                }

                // Extract multipliers from dropdown text
                const activityMultiplier = parseFloat(activityText.split(' ')[0]);
                const goalOffset = parseFloat(goalText.split(' ')[0]);

                // Calculate TDEE and final goal
                const tdee = bmr * activityMultiplier;
                const dailyGoal = Math.round(tdee + goalOffset);

                return {
                    bmr: Math.round(bmr),
                    tdee: Math.round(tdee),
                    dailyGoal: dailyGoal
                };
            }

            function updateGoalPreview() {
                const calculation = calculateGoal();
                const preview = document.getElementById('goalPreview');

                if (calculation) {
                    document.getElementById('goalCalculation').innerHTML = `
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <strong>BMR</strong><br>
                            <span class="h5">${calculation.bmr}</span> cal/day
                        </div>
                        <div class="col-md-4 text-center">
                            <strong>TDEE</strong><br>
                            <span class="h5">${calculation.tdee}</span> cal/day
                        </div>
                        <div class="col-md-4 text-center">
                            <strong>Daily Goal</strong><br>
                            <span class="h4 text-primary">${calculation.dailyGoal}</span> cal/day
                        </div>
                    </div>
                `;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            }

            function showAlert(type, message) {
                const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

                const existingAlert = document.querySelector('.alert');
                if (existingAlert && existingAlert.classList.contains('alert-danger') || existingAlert.classList.contains('alert-success')) {
                    existingAlert.remove();
                }

                document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);
            }

            // Add event listeners for real-time calculation updates
            ['gender', 'weight', 'height', 'age', 'activityLevel', 'goalOffset'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateGoalPreview);
                document.getElementById(id).addEventListener('input', updateGoalPreview);
            });

            // Initial calculation if form has values
            updateGoalPreview();
        </script>
</body>

</html>